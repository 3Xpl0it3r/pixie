# Generated file: bazel run //templates/skaffold:skaffoldtemplate
# DO NOT EDIT
apiVersion: skaffold/v1beta8
kind: Config
build:
  tagPolicy:
    envTemplate:
      template: "{{`{{.IMAGE_NAME}}:{{.PL_IMAGE_TAG}}`}}"
  artifacts:
  - image: gcr.io/pl-dev-infra/agent_image
    context: .
    bazel:
      target: //src/vizier/services/agent:agent_image.tar
  - image: gcr.io/pl-dev-infra/vizier_metadata
    context: .
    bazel:
      target: //src/vizier/services/metadata:vizier_metadata_image.tar
  - image: gcr.io/pl-dev-infra/api_server_image
    context: .
    bazel:
      target: //src/services/api:api_server_image.tar
  - image: gcr.io/pl-dev-infra/vizier_query_broker
    context: .
    bazel:
      target: //src/vizier/services/query_broker:vizier_query_broker_image.tar
  - image: gcr.io/pl-dev-infra/api_server_image
    context: .
    bazel:
      target: //src/services/api:api_server_image.tar
  - image: gcr.io/pl-dev-infra/proxy_image
    context: .
    bazel:
      target: //src/services/proxy:proxy_prod_image.tar
  local:
    push: true
deploy:
  kubectl:
    manifests:
    - {{.BuildDir}}/src/vizier/services/agent/agent_{{.Deployment}}.yaml
    - {{.BuildDir}}/src/vizier/services/query_broker/service_{{.Deployment}}.yaml
    - {{.BuildDir}}/src/vizier/services/metadata/service_{{.Deployment}}.yaml
    - {{.BuildDir}}/src/services/api/service_{{.Deployment}}.yaml
    - {{.BuildDir}}/src/services/api/service_{{.Deployment}}.yaml
    - {{.BuildDir}}/src/services/proxy/service_{{.Deployment}}.yaml
profiles:
  - name: dev
    activation:
      - command: dev
    patches:
      # Use default tag policy (hash) for dev builds.
      - op: remove
        path: /build/tagPolicy/envTemplate
      # Don't push images in the dev build.
      - op: replace
        path: /build
        value:
          local:
            push: false

  - name: nightly
    activation:
      - env: PL_BUILD_TYPE=nightly
    patches:
      # Add customer docs to the nightly build.
      - op: add
        path: /build/artifacts/-
        value:
          image: gcr.io/pl-dev-infra/customer_docs_prod_image
          context: .
          bazel:
            target: //docs/customer:customer_docs_prod_image.tar

      - op: add
        path: /deploy/kubectl/manifests/-
        value: {{.BuildDir}}/docs/customer/service_{{.Deployment}}.yaml

      # Set compilation to be opt build.
      - op: add
        path: /build/artifacts/context=./bazel/args
        value: ["--compilation_mode=opt"]
